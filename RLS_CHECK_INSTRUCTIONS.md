# üîí –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ RLS –ø–æ–ª–∏—Ç–∏–∫

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

### –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ Supabase

1. **–û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard:**
   - –ó–∞–π–¥–∏—Ç–µ –Ω–∞ https://supabase.com
   - –í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç

2. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ SQL Editor:**
   - –í –ª–µ–≤–æ–º –º–µ–Ω—é –≤—ã–±–µ—Ä–∏—Ç–µ **SQL Editor**
   - –ù–∞–∂–º–∏—Ç–µ **New query**

3. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `security_check.sql` –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
   - –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor
   - –ù–∞–∂–º–∏—Ç–µ **Run** (–∏–ª–∏ `Ctrl+Enter` / `Cmd+Enter`)

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –≤–∏–¥–µ:

#### ‚úÖ –£—Å–ø–µ—à–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
```
NOTICE: ‚úÖ RLS –≤–∫–ª—é—á–µ–Ω –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã employees
NOTICE: ‚úÖ –ù–∞–π–¥–µ–Ω–æ 2 –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã employees
NOTICE: ‚úÖ –§—É–Ω–∫—Ü–∏—è is_admin() —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
```

#### ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:
```
WARNING: ‚ö†Ô∏è –ù–µ—Ç –ø–æ–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã ...
```

#### ‚ùå –û—à–∏–±–∫–∏:
```
ERROR: RLS –Ω–µ –≤–∫–ª—é—á–µ–Ω –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã ...
ERROR: –§—É–Ω–∫—Ü–∏—è is_admin() –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!
```

### –®–∞–≥ 3: –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

1. **RLS –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü:**
   - ‚úÖ `employees`
   - ‚úÖ `employee_attachments`
   - ‚úÖ `statistics_definitions`
   - ‚úÖ `statistics_values`
   - ‚úÖ `org_metadata`
   - ‚úÖ `departments`
   - ‚úÖ `subdepartments`

2. **–ü–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç:**
   - –î–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ SELECT, INSERT, UPDATE, DELETE

3. **–§—É–Ω–∫—Ü–∏—è is_admin() —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

4. **–ù–µ—Ç –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
   - –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º

### –®–∞–≥ 4: –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏

#### –ï—Å–ª–∏ RLS –Ω–µ –≤–∫–ª—é—á–µ–Ω:
```sql
-- –í–∫–ª—é—á–∏—Ç—å RLS –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
ALTER TABLE public.employees ENABLE ROW LEVEL SECURITY;
```

#### –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª–∏—Ç–∏–∫:
–í—ã–ø–æ–ª–Ω–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç —Å—Ö–µ–º—ã:
- –û—Ç–∫—Ä–æ–π—Ç–µ `supabase_schema_complete.sql`
- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ –≤ SQL Editor
- –≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏

#### –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è is_admin() –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:
```sql
-- –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é is_admin()
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN (
    (auth.jwt() -> 'app_metadata' ->> 'role') = 'admin' OR
    (auth.jwt() -> 'user_metadata' ->> 'is_admin')::boolean = TRUE
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### –®–∞–≥ 5: –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å RLS:**
```sql
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename IN ('employees', 'org_metadata');
```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏:**
```sql
SELECT tablename, policyname, cmd 
FROM pg_policies 
WHERE schemaname = 'public';
```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é:**
```sql
SELECT proname, prosrc 
FROM pg_proc 
WHERE proname = 'is_admin';
```

## üìã –ß–µ–∫–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] –û—Ç–∫—Ä—ã–ª Supabase Dashboard
- [ ] –ü–µ—Ä–µ—à–µ–ª –≤ SQL Editor
- [ ] –í—ã–ø–æ–ª–Ω–∏–ª `security_check.sql`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã - –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ
- [ ] –ï—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏ - –∏—Å–ø—Ä–∞–≤–∏–ª –∏—Ö
- [ ] –ü–æ–≤—Ç–æ—Ä–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–ª —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

## ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
- ‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç RLS –≤–∫–ª—é—á–µ–Ω–Ω—ã–π
- ‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –§—É–Ω–∫—Ü–∏—è is_admin() —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –ù–µ—Ç –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ - –≤–∞—à–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞—â–∏—â–µ–Ω–∞! üéâ

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `security_check.sql` - –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
- `supabase_schema_complete.sql` - –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç —Å—Ö–µ–º—ã —Å –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏
- `create_integration_tokens_table.sql` - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–∫–µ–Ω–æ–≤ (—Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç RLS)

